{% extends "base.html" %}

{% block title %}LearnWords - Тест: {{ word.word }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Тестирование знаний</h1>
            <div class="progress" style="height: 10px;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: {{ (current / total * 100) | int }}%;" 
                     aria-valuenow="{{ (current / total * 100) | int }}" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <small class="text-muted">Вопрос {{ current }} из {{ total }}</small>
                <small class="text-muted">Сложность: {{ test_session.difficulty }}</small>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card test-card">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">{{ test.question }}</h2>
                </div>
                <div class="card-body test-container" data-test-id="{{ test.id }}" data-session-id="{{ test_session.id }}">
                    <div class="word-display mb-4 text-center">
                        <h3 class="display-5 word-highlight">{{ word.word }}</h3>
                        {% if word.example %}
                        <p class="text-muted fst-italic">{{ word.example }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="options-container">
                        {% for option in options %}
                        <div class="form-check mb-3 p-0">
                            <button class="btn btn-outline-primary w-100 option-btn py-3" data-option="{{ option }}">
                                {{ option }}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="result-container mt-4 d-none">
                        <div class="correct-answer-container alert alert-success d-none">
                            <h4 class="alert-heading">Правильно!</h4>
                            <p class="mb-0">Верный ответ: <strong class="correct-answer"></strong></p>
                        </div>
                        <div class="wrong-answer-container alert alert-danger d-none">
                            <h4 class="alert-heading">Неправильно!</h4>
                            <p class="mb-0">Верный ответ: <strong class="correct-answer"></strong></p>
                        </div>
                        
                        {% if word.context %}
                        <div class="context-container mt-3 p-3 bg-light rounded">
                            <h5 class="h6"><i class="fas fa-film me-2"></i>Контекст:</h5>
                            <p class="mb-0">{{ word.context }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                            <button class="btn btn-primary next-btn">Следующий вопрос</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const testContainer = document.querySelector('.test-container');
        const optionButtons = document.querySelectorAll('.option-btn');
        const resultContainer = document.querySelector('.result-container');
        const correctContainer = document.querySelector('.correct-answer-container');
        const wrongContainer = document.querySelector('.wrong-answer-container');
        const correctAnswerElements = document.querySelectorAll('.correct-answer');
        const nextButton = document.querySelector('.next-btn');
        
        const testId = testContainer.dataset.testId;
        const sessionId = testContainer.dataset.sessionId;
        
        // Обработка клика по варианту ответа
        optionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const selectedOption = this.dataset.option;
                
                // Блокируем все кнопки
                optionButtons.forEach(btn => btn.setAttribute('disabled', 'disabled'));
                
                // Отправляем ответ на сервер
                fetch('{{ url_for("main.submit_test_answer") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_id: testId,
                        session_id: sessionId,
                        answer: selectedOption
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Отображаем результат
                    if (data.is_correct) {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-success');
                        correctContainer.classList.remove('d-none');
                    } else {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-danger');
                        wrongContainer.classList.remove('d-none');
                        
                        // Подсвечиваем правильный ответ
                        optionButtons.forEach(btn => {
                            if (btn.dataset.option === data.correct_answer) {
                                btn.classList.remove('btn-outline-primary');
                                btn.classList.add('btn-success');
                            }
                        });
                    }
                    
                    // Показываем правильный ответ
                    correctAnswerElements.forEach(el => {
                        el.textContent = data.correct_answer;
                    });
                    
                    // Показываем контейнер результата
                    resultContainer.classList.remove('d-none');
                    
                    // Изменяем текст кнопки, если это последний вопрос
                    if (data.is_last) {
                        nextButton.textContent = 'Завершить тест';
                    }
                    
                    // Устанавливаем URL для перехода к следующему вопросу
                    nextButton.dataset.nextUrl = data.next_url;
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
            });
        });
        
        // Обработка клика по кнопке "Следующий вопрос"
        nextButton.addEventListener('click', function() {
            window.location.href = this.dataset.nextUrl;
        });
    });
</script>
{% endblock %} 
 
 